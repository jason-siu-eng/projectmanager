<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Scheduler</title>

  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  />

  <!-- Material Icons for settings gear -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* 1. Box‐sizing so width:100% includes padding/border */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    /* 2. Center wrapper */
    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* 3. Header + controls */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #settingsBtn,
    #syncBtn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    #settingsBtn .material-icons,
    #syncBtn img {
      width: 24px;
      height: 24px;
    }
    #syncStatus {
      font-size: 0.9rem;
      color: #555;
    }

    /* 4. Form controls */
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
    }
    input,
    select,
    button[type="submit"] {
      display: block;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }

    /* 5. Task outline & Add‐to‐calendar button */
    #outline {
      margin-top: 2rem;
    }
    #addCalendarBtn {
      display: none;
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    #addCalendarBtn:hover {
      background: #218838;
    }

    /* 6. Calendar container */
    #calendar {
      margin-top: 2rem;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* 7. FullCalendar button tweaks */
    .fc .fc-button {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      height: 28px;
      line-height: 1;
    }
    .fc .fc-prev-button,
    .fc .fc-next-button {
      width: 32px;
      padding: 0;
    }
    .fc .fc-button-group {
      gap: 4px;
    }
    .fc-header-toolbar {
      flex-wrap: nowrap !important;
    }

    /* 8. Settings modal overlay */
    #settingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    /* 9. Settings modal content (solid white + border) */
    #settingsModal .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      position: relative;
      border: 1px solid #000; /* black border */
    }
    #settingsModal .close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 1.5rem;
      cursor: pointer;
    }
    /* 10. New settings controls styling */
    #settingsModal .form-group.days {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    #settingsModal .form-group.days label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0;
    }

    /* 11. Task header row styling for three columns */
    .task-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .task-header .task-outline-header {
      flex: 1;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }
    .task-header .duration-header {
      width: 4.5rem;
      text-align: left;
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
      margin-left: 0.5rem;
    }
    .task-header .action-header {
      width: 3rem;
      text-align: left;
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
      margin-left: 0.5rem;
    }

    /* 12. Task list item styling */
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .task-list li {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .task-number {
      width: 1.5rem;
      font-size: 1rem;
      color: #333;
    }
    .task-input {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
    }
    .task-duration {
      width: 4.5rem;
      margin-left: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    .task-plus,
    .task-minus {
      display: inline-block;
      width: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
      font-size: 1.2rem;
      user-select: none;
    }
    .task-plus {
      color: blue;
    }
    .task-minus {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Task Scheduler</h1>
      <div class="header-controls">
        <!-- Settings gear -->
        <button id="settingsBtn" title="Settings">
          <span class="material-icons">settings</span>
        </button>
        <!-- Google Sync -->
        <div class="sync">
          <button id="syncBtn" title="Sync Google">
            <img
              src="https://developers.google.com/identity/images/g-logo.png"
              alt="Sync"
            />
          </button>
          <span id="syncStatus">Not synced</span>
        </div>
      </div>
    </div>

    <form id="goalForm">
      <div class="form-group">
        <label for="goalInput">What is your goal?</label>
        <input type="text" id="goalInput" required/>
      </div>
      <div class="form-group">
        <label for="levelSelect">Proficiency level</label>
        <select id="levelSelect">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="form-group">
        <label for="deadlineInput">Deadline (YYYY-MM-DD)</label>
        <input type="date" id="deadlineInput" required/>
      </div>
      <button type="submit">Generate Tasks</button>
    </form>

    <div id="outline"></div>
    <button id="addCalendarBtn">Add to Calendar</button>
    <div id="calendar"></div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <div class="modal-content">
      <span class="close" id="closeSettings">&times;</span>
      <h2>Settings</h2>
      <!-- Max hours per day -->
      <div class="form-group">
        <label for="maxHoursPerDay">Max hours/day</label>
        <input type="number" id="maxHoursPerDay" min="1" value="8"/>
      </div>
      <!-- Allowed days of week -->
      <div class="form-group days">
        <label><input type="checkbox" value="MO" checked/> Mon</label>
        <label><input type="checkbox" value="TU" checked/> Tue</label>
        <label><input type="checkbox" value="WE" checked/> Wed</label>
        <label><input type="checkbox" value="TH" checked/> Thu</label>
        <label><input type="checkbox" value="FR" checked/> Fri</label>
        <label><input type="checkbox" value="SA"/> Sat</label>
        <label><input type="checkbox" value="SU"/> Sun</label>
      </div>
      <button id="saveSettings">Save</button>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ─── FullCalendar TIME‐GRID initialization ───────────────
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        // 1) Show a 7‐day horizontal time grid, with vertical time axis:
        initialView: 'timeGridWeek',

        // 2) Toolbar at top: Prev | Today | Next   Title   timeGridWeek, timeGridDay
        headerToolbar: {
          left: 'prev today next',
          center: 'title',
          right: 'timeGridWeek timeGridDay'
        },

        // 3) Do NOT show the “all‐day” slot row:
        allDaySlot: false,

        // 4) Only show slots from 6:00 AM through 10:00 PM:
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',

        // 5) Show a thin “current time” marker line:
        nowIndicator: true,

        // 6) Make events non‐editable (for now):
        editable: false,
        selectable: false,

        // 7) Set a consistent height so it looks like a “daily planner”:
        height: 'auto'
      });
      calendar.render();

      // ─── Google Sync (timeGrid) ────────────────────────────────
      const syncBtn    = document.getElementById('syncBtn');
      const syncStatus = document.getElementById('syncStatus');
      async function syncGoogleEvents() {
        syncStatus.textContent = 'Syncing…';
        try {
          const resp = await fetch('/api/events', { credentials: 'include' });
          if (resp.status === 401) {
            // not authenticated → redirect to /login
            window.location.href = '/login';
            return;
          }
          const { events } = await resp.json();

          // 1) Remove all existing events:
          calendar.removeAllEvents();

          // 2) Add new events in “timeGrid” format:
          calendar.addEventSource(events);

          syncStatus.textContent = 'Synced';
        } catch (err) {
          console.error('Sync error', err);
          syncStatus.textContent = 'Sync failed';
        }
      }
      syncBtn.addEventListener('click', syncGoogleEvents);

      // ─── Task Generation ────────────────────────────
      const form       = document.getElementById('goalForm');
      const outlineDiv = document.getElementById('outline');
      const addBtn     = document.getElementById('addCalendarBtn');
      let lastTasks    = [];
      let lastDeadline = '';

      form.addEventListener('submit', async e => {
        e.preventDefault();
        outlineDiv.innerHTML = '<p>Loading tasks…</p>';
        addBtn.style.display = 'none';

        const goal     = document.getElementById('goalInput').value;
        const level    = document.getElementById('levelSelect').value;
        const deadline = document.getElementById('deadlineInput').value;
        lastDeadline = deadline;

        const resp = await fetch('/api/tasks', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ goal, level, deadline })
        });
        const { tasks } = await resp.json();
        lastTasks = tasks || [];

        // ─── Build header row ─────────────────────
        outlineDiv.innerHTML = '';
        const headerRow = document.createElement('div');
        headerRow.className = 'task-header';
        headerRow.innerHTML = `
          <div class="task-outline-header">Task Outline</div>
          <div class="duration-header">Duration (hr)</div>
          <div class="action-header">Add Task</div>
        `;
        outlineDiv.appendChild(headerRow);

        // ─── Build task list ───────────────────────
        const ol = document.createElement('ol');
        ol.className = 'task-list';
        lastTasks.forEach((t, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="task-number">${idx + 1}.</div>
            <input type="text" class="task-input" value="${t.task.replace(/"/g,'&quot;')}" />
            <input
              type="number"
              class="task-duration"
              value="${t.duration_hours || 1}"
              min="0.5"
              step="0.5"
            />
            <span class="task-plus">＋</span>
            <span class="task-minus">—</span>
          `;
          ol.appendChild(li);
        });
        outlineDiv.appendChild(ol);

        // ─── Wire up + / − buttons ─────────────────
        document.querySelectorAll('.task-plus').forEach(btn => {
          btn.addEventListener('click', () => {
            const durationInput = btn.previousElementSibling;
            let curr = parseFloat(durationInput.value) || 0;
            curr += 0.5;
            durationInput.value = curr.toFixed(1);
          });
        });
        document.querySelectorAll('.task-minus').forEach(btn => {
          btn.addEventListener('click', () => {
            const durationInput = btn.previousElementSibling.previousElementSibling;
            let curr = parseFloat(durationInput.value) || 0;
            if (curr > 0.5) {
              curr -= 0.5;
              durationInput.value = curr.toFixed(1);
            }
          });
        });

        // ─── Reveal "Add to Calendar" ──────────────
        addBtn.style.display = 'block';
      });

      // ─── Add to Calendar ─────────────────────────
      addBtn.addEventListener('click', async () => {
        addBtn.disabled = true;
        addBtn.textContent = 'Adding…';

        // Update lastTasks with any user edits
        const descriptionInputs = outlineDiv.querySelectorAll('.task-input');
        const durationInputs    = outlineDiv.querySelectorAll('.task-duration');
        lastTasks.forEach((t, idx) => {
          t.task = descriptionInputs[idx].value;
          t.duration_hours = parseFloat(durationInputs[idx].value) || 1;
        });

        // Get "maxHoursPerDay" and "allowedDays" from localStorage
        const maxPerDay   = parseInt(localStorage.getItem('maxHoursPerDay') || '8', 10);
        const allowedDays = JSON.parse(localStorage.getItem('allowedDays') || '[]');

        const resp = await fetch('/api/schedule', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: lastTasks,
            start_date: new Date().toISOString(),
            deadline: lastDeadline,
            settings: {
              maxHoursPerDay: maxPerDay,
              allowedDaysOfWeek: allowedDays
            }
          })
        });
        const data = await resp.json();

        if (!resp.ok) {
          alert("Error scheduling tasks: " + (data.message || data.error));
        } else {
          if (data.unscheduled?.length) {
            const lines = data.unscheduled.map(u =>
              `Could not schedule task #${u.id}: ${u.task}`
            );
            alert(lines.join("\n"));
          }
          await syncGoogleEvents();
        }

        addBtn.textContent = 'Done!';
        setTimeout(() => {
          addBtn.style.display = 'none';
          addBtn.disabled = false;
          addBtn.textContent = 'Add to Calendar';
        }, 1500);
      });

      // ─── Settings Popup ────────────────────────────
      const settingsBtn   = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings  = document.getElementById('saveSettings');

      settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
      });
      closeSettings.addEventListener('click', () => {
        settingsModal.style.display = 'none';
      });
      window.addEventListener('click', e => {
        if (e.target === settingsModal) settingsModal.style.display = 'none';
      });

      // Persist settings
      saveSettings.addEventListener('click', () => {
        const maxHrs = parseInt(document.getElementById('maxHoursPerDay').value, 10);
        const days   = Array.from(
          document.querySelectorAll('#settingsModal .form-group.days input:checked')
        ).map(cb => cb.value);

        localStorage.setItem('maxHoursPerDay', maxHrs);
        localStorage.setItem('allowedDays', JSON.stringify(days));
        settingsModal.style.display = 'none';
      });

      // Load settings into form
      const storedMax = localStorage.getItem('maxHoursPerDay');
      if (storedMax) {
        document.getElementById('maxHoursPerDay').value = storedMax;
      }
      const storedDays = JSON.parse(localStorage.getItem('allowedDays') || '[]');
      if (storedDays.length) {
        document.querySelectorAll('#settingsModal .form-group.days input')
          .forEach(cb => cb.checked = storedDays.includes(cb.value));
      }
    });
  </script>
</body>
</html>
