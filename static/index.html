<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Scheduler</title>

  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  />

  <!-- Material Icons for settings gear -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* 1. Box-sizing so width:100% includes padding/border */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    /* 2. Center wrapper */
    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* 3. Header + controls */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #settingsBtn,
    #syncBtn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    #settingsBtn .material-icons,
    #syncBtn img {
      width: 24px;
      height: 24px;
    }
    #syncStatus {
      font-size: 0.9rem;
      color: #555;
    }

    /* 4. Form controls */
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
    }
    input, select, button[type="submit"] {
      display: block;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }

    /* 5. Task outline & Add-to-calendar button */
    #outline {
      margin-top: 2rem;
    }
    #addCalendarBtn {
      display: none;
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    #addCalendarBtn:hover {
      background: #218838;
    }

    /* 6. Calendar container */
    #calendar {
      margin-top: 2rem;
    }

    /* 7. FullCalendar button tweaks */
    .fc .fc-button {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      height: 28px;
      line-height: 1;
    }
    .fc .fc-prev-button,
    .fc .fc-next-button {
      width: 32px;
      padding: 0;
    }
    .fc .fc-button-group {
      gap: 4px;
    }
    .fc-header-toolbar {
      flex-wrap: nowrap !important;
    }

/* Make the overlay transparent so you can see the page behind it */
#settingsModal {
  display: none;           /* or “flex” when shown */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent; /* ← transparent overlay */
  justify-content: center;
  align-items: center;
  overflow: auto;
  z-index: 999;            /* sit above all other content */
}

/* The actual settings box: solid white + border */
#settingsModal .modal-content {
  background: white;
  padding: 1rem;
  border-radius: 8px;
  border: 2px solid black; /* ← black border */
  max-width: 600px;
  width: 90%;
  position: relative;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}


    #settingsModal .close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* 10. Settings controls styling */
    #settingsModal .form-group.days {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    #settingsModal .form-group.days label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Task Scheduler</h1>
      <div class="header-controls">
        <!-- Settings gear -->
        <button id="settingsBtn" title="Settings">
          <span class="material-icons">settings</span>
        </button>
        <!-- Google Sync -->
        <div class="sync">
          <button id="syncBtn" title="Sync Google">
            <img
              src="https://developers.google.com/identity/images/g-logo.png"
              alt="Sync"
            />
          </button>
          <span id="syncStatus">Not synced</span>
        </div>
      </div>
    </div>

    <form id="goalForm">
      <div class="form-group">
        <label for="goalInput">What is your goal?</label>
        <input type="text" id="goalInput" required/>
      </div>
      <div class="form-group">
        <label for="levelSelect">Proficiency level</label>
        <select id="levelSelect">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="form-group">
        <label for="deadlineInput">Deadline (YYYY-MM-DD)</label>
        <input type="date" id="deadlineInput" required/>
      </div>
      <button type="submit">Generate Tasks</button>
    </form>

    <div id="outline"></div>
    <button id="addCalendarBtn">Add to Calendar</button>
    <div id="calendar"></div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <div class="modal-content">
      <span class="close" id="closeSettings">&times;</span>
      <h2>Settings</h2>
      <!-- Max events per day -->
      <div class="form-group">
        <label for="maxEventsPerDay">Max events/day</label>
        <input type="number" id="maxEventsPerDay" min="1" value="3"/>
      </div>
      <!-- Allowed days of week -->
      <div class="form-group days">
        <label><input type="checkbox" value="MO" checked/> Mon</label>
        <label><input type="checkbox" value="TU" checked/> Tue</label>
        <label><input type="checkbox" value="WE" checked/> Wed</label>
        <label><input type="checkbox" value="TH" checked/> Thu</label>
        <label><input type="checkbox" value="FR" checked/> Fri</label>
        <label><input type="checkbox" value="SA"/> Sat</label>
        <label><input type="checkbox" value="SU"/> Sun</label>
      </div>
      <button id="saveSettings">Save</button>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ─── FullCalendar initialization ─────────────────────────────────────────
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridWeek',
        headerToolbar: {
          left: 'prev,today,next',
          center: 'title',
          right: 'dayGridWeek,dayGridDay'
        },
        editable: false,
        selectable: false
      });
      calendar.render();

      // ─── Google Sync ─────────────────────────────────────────────────────────
      const syncBtn    = document.getElementById('syncBtn');
      const syncStatus = document.getElementById('syncStatus');

      async function syncGoogleEvents() {
        syncStatus.textContent = 'Syncing…';
        try {
          const resp = await fetch('/api/events', { credentials: 'include' });
          if (resp.status === 401) {
            // not authenticated → redirect to /login
            window.location.href = '/login';
            return;
          }
          const { events } = await resp.json();
          calendar.removeAllEvents();
          calendar.addEventSource(events);
          syncStatus.textContent = 'Synced';
        } catch (err) {
          console.error('Sync error', err);
          syncStatus.textContent = 'Sync failed';
        }
      }
      syncBtn.addEventListener('click', syncGoogleEvents);

      // ─── Task Generation ────────────────────────────────────────────────────
      const form       = document.getElementById('goalForm');
      const outlineDiv = document.getElementById('outline');
      const addBtn     = document.getElementById('addCalendarBtn');
      let lastTasks    = [];
      let lastDeadline = '';

      form.addEventListener('submit', async e => {
        e.preventDefault();
        outlineDiv.innerHTML = '<p>Loading tasks…</p>';
        addBtn.style.display = 'none';

        const goal     = document.getElementById('goalInput').value;
        const level    = document.getElementById('levelSelect').value;
        const deadline = document.getElementById('deadlineInput').value;
        lastDeadline = deadline;

        const resp = await fetch('/api/tasks', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ goal, level, deadline })
        });
        const { tasks } = await resp.json();
        lastTasks = tasks || [];

        // Render outline
        outlineDiv.innerHTML = '<h2>Task Outline</h2>';
        const ol = document.createElement('ol');
        lastTasks.forEach(t => {
          const li = document.createElement('li');
          li.textContent = t.task;
          ol.appendChild(li);
        });
        outlineDiv.appendChild(ol);
        addBtn.style.display = 'block';
      });

      // ─── Add to Calendar ────────────────────────────────────────────────────
      addBtn.addEventListener('click', async () => {
        addBtn.disabled = true;
        addBtn.textContent = 'Adding…';

        // get settings
        const maxPerDay   = parseInt(localStorage.getItem('maxEventsPerDay') || '3', 10);
        const allowedDays = JSON.parse(localStorage.getItem('allowedDays') || '[]');

        const resp = await fetch('/api/schedule', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: lastTasks,
            start_date: new Date().toISOString(),
            deadline: lastDeadline,
            settings: {
              maxEventsPerDay: maxPerDay,
              allowedDaysOfWeek: allowedDays
            }
          })
        });
        const data = await resp.json();

        if (!resp.ok) {
          alert("Error scheduling tasks: " + (data.message || data.error));
        } else {
          if (data.unscheduled?.length) {
            alert(data.unscheduled.map(u => `Could not schedule #${u.id}: ${u.task}`).join("\n"));
          }
          await syncGoogleEvents();
        }

        addBtn.textContent = 'Done!';
        setTimeout(() => {
          addBtn.style.display = 'none';
          addBtn.disabled = false;
          addBtn.textContent = 'Add to Calendar';
        }, 1500);
      });

      // ─── Settings Popup ──────────────────────────────────────────────────────
      const settingsBtn   = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings  = document.getElementById('saveSettings');

      settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
      });
      closeSettings.addEventListener('click', () => {
        settingsModal.style.display = 'none';
      });
      window.addEventListener('click', e => {
        if (e.target === settingsModal) settingsModal.style.display = 'none';
      });

      // Persist settings (no preferredTime)
      saveSettings.addEventListener('click', () => {
        const maxEvt = parseInt(document.getElementById('maxEventsPerDay').value, 10);
        const days   = Array.from(
          document.querySelectorAll('#settingsModal .form-group.days input:checked')
        ).map(cb => cb.value);

        localStorage.setItem('maxEventsPerDay', maxEvt);
        localStorage.setItem('allowedDays', JSON.stringify(days));
        settingsModal.style.display = 'none';
      });

      // Load settings into form (no preferredTime)
      const storedMax = localStorage.getItem('maxEventsPerDay');
      if (storedMax) {
        document.getElementById('maxEventsPerDay').value = storedMax;
      }
      const storedDays = JSON.parse(localStorage.getItem('allowedDays') || '[]');
      if (storedDays.length) {
        document.querySelectorAll('#settingsModal .form-group.days input')
          .forEach(cb => cb.checked = storedDays.includes(cb.value));
      }
    });
  </script>
</body>
</html>
